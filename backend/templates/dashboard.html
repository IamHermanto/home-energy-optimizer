<!DOCTYPE html>
<html>
<head>
    <title>Home Energy Optimizer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #0f1419;
            color: #e8eaed;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { margin-bottom: 30px; font-size: 32px; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #1a1f29;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #2d3748;
        }
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #10b981;
            margin: 10px 0;
        }
        .stat-label {
            color: #9ca3af;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .chart-container {
            background: #1a1f29;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 1px solid #2d3748;
            position: relative;
            min-height: 400px;
        }
        .chart-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: #e8eaed;
        }
        .recommendations {
            background: #1a1f29;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #2d3748;
        }
        .rec-item {
            padding: 15px;
            margin-bottom: 10px;
            background: #0f1419;
            border-radius: 6px;
            border-left: 3px solid #10b981;
        }
        .rec-hour { font-weight: bold; color: #60a5fa; }
        .rec-action { color: #10b981; margin: 5px 0; }
        .rec-reason { color: #9ca3af; font-size: 14px; }
        canvas { max-height: 400px; }
        
        /* Loading spinner */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            text-align: center;
        }
        .loading.active {
            display: block;
        }
        .spinner {
            border: 3px solid #2d3748;
            border-top: 3px solid #10b981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            color: #9ca3af;
            font-size: 14px;
        }
        
        /* Info message */
        .info-message {
            background: #1e3a5f;
            border: 1px solid #2563eb;
            color: #93c5fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        /* Error message */
        .error-message {
            background: #7f1d1d;
            border: 1px solid #991b1b;
            color: #fca5a5;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        .error-message.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”‹ Home Energy Management System</h1>
        
        <div class="info-message">
            <strong>Note:</strong> Demo data is being generated. Initial load may take a few seconds.
            <button onclick="forceRegenerate()" style="margin-left: 20px; padding: 5px 15px; background: #2563eb; border: none; color: white; border-radius: 4px; cursor: pointer;">
                Force Regenerate Data
            </button>
            <button onclick="checkStatus()" style="margin-left: 10px; padding: 5px 15px; background: #059669; border: none; color: white; border-radius: 4px; cursor: pointer;">
                Check Status
            </button>
        </div>
        
        <div class="error-message" id="errorMsg"></div>
        <div class="info-message" id="debugInfo" style="display: none;"></div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Grid Independence</div>
                <div class="stat-value" id="independence">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Annual Savings</div>
                <div class="stat-value" id="savings">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Solar Generated</div>
                <div class="stat-value" id="solar">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Grid Import Reduced</div>
                <div class="stat-value" id="reduction">--</div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">Energy Flow (Last 24 Hours)</div>
            <div class="loading active" id="energyLoading">
                <div class="spinner"></div>
                <div class="loading-text">Loading energy data...</div>
            </div>
            <canvas id="energyChart"></canvas>
        </div>

        <div class="chart-container">
            <div class="chart-title">Cost Comparison</div>
            <div class="loading active" id="costLoading">
                <div class="spinner"></div>
                <div class="loading-text">Calculating costs...</div>
            </div>
            <canvas id="costChart"></canvas>
        </div>

        <div class="recommendations">
            <div class="chart-title">Optimization Recommendations (Next 24 Hours)</div>
            <div id="recList">Loading recommendations...</div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/energy';
        let retryCount = 0;
        const MAX_RETRIES = 5;

        // Debug functions
        async function forceRegenerate() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.textContent = 'Regenerating data... This may take 10-15 seconds...';
            debugInfo.style.display = 'block';
            
            try {
                const response = await fetch('/api/debug/regenerate', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    debugInfo.textContent = `Success! Generated ${data.count} records. Reloading page...`;
                    setTimeout(() => location.reload(), 2000);
                } else {
                    debugInfo.textContent = `Error: ${data.error}`;
                }
            } catch (error) {
                debugInfo.textContent = `Error: ${error.message}`;
            }
        }

        async function checkStatus() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.style.display = 'block';
            debugInfo.textContent = 'Checking database status...';
            
            try {
                const response = await fetch('/api/debug/status');
                const data = await response.json();
                
                if (data.error) {
                    debugInfo.textContent = `Database Error: ${data.error}`;
                } else {
                    debugInfo.textContent = `Database has ${data.record_count} records. Date range: ${data.date_range.min} to ${data.date_range.max}. Using: ${data.database_url}`;
                }
            } catch (error) {
                debugInfo.textContent = `Error: ${error.message}`;
            }
        }

        // Error handling wrapper with retry
        async function fetchWithRetry(url, attempt = 1) {
            try {
                console.log(`Fetching ${url} (attempt ${attempt}/${MAX_RETRIES})`);
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                const data = await response.json();
                
                // Check if we got empty data
                if (Array.isArray(data) && data.length === 0) {
                    throw new Error('No data available');
                }
                
                return data;
            } catch (error) {
                console.error(`Fetch error (attempt ${attempt}):`, error);
                
                if (attempt < MAX_RETRIES) {
                    // Show retry message
                    const errorMsg = document.getElementById('errorMsg');
                    errorMsg.textContent = `Loading data... Attempt ${attempt}/${MAX_RETRIES}. Please wait.`;
                    errorMsg.classList.add('active');
                    
                    // Wait before retry (exponential backoff)
                    const delay = Math.min(1000 * Math.pow(2, attempt - 1), 10000);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    
                    return fetchWithRetry(url, attempt + 1);
                } else {
                    throw new Error(`Failed after ${MAX_RETRIES} attempts: ${error.message}`);
                }
            }
        }

        // Fetch and display stats
        async function loadStats() {
            try {
                const stats = await fetchWithRetry(`${API_BASE}/stats`);
                document.getElementById('independence').textContent = stats.grid_independence + '%';
                document.getElementById('solar').textContent = stats.total_solar.toFixed(1) + ' kWh';
                
                const reduction = ((1 - stats.total_grid_import / stats.total_consumption) * 100).toFixed(1);
                document.getElementById('reduction').textContent = reduction + '%';
                
                // Clear error message on success
                document.getElementById('errorMsg').classList.remove('active');
            } catch (error) {
                console.error('Error loading stats:', error);
                const errorMsg = document.getElementById('errorMsg');
                errorMsg.textContent = 'Unable to load statistics. Please refresh the page.';
                errorMsg.classList.add('active');
            }
        }

        // Fetch and display cost analysis
        async function loadCostAnalysis() {
            const loading = document.getElementById('costLoading');
            loading.querySelector('.loading-text').textContent = 'Calculating costs...';
            
            try {
                const cost = await fetchWithRetry(`${API_BASE}/cost-analysis`);
                document.getElementById('savings').textContent = '$' + cost.annual_projection.toFixed(0);
                
                // Cost comparison chart
                const ctx = document.getElementById('costChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Grid Only', 'With Battery System'],
                        datasets: [{
                            label: 'Weekly Cost ($)',
                            data: [cost.grid_only_cost, cost.with_battery_cost],
                            backgroundColor: ['#ef4444', '#10b981']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#9ca3af' },
                                grid: { color: '#2d3748' }
                            },
                            x: {
                                ticks: { color: '#9ca3af' },
                                grid: { display: false }
                            }
                        }
                    }
                });
                
                loading.classList.remove('active');
            } catch (error) {
                console.error('Error loading cost analysis:', error);
                loading.querySelector('.loading-text').textContent = 'Failed to load cost data';
            }
        }

        // Fetch and display hourly data
        async function loadEnergyChart() {
            const loading = document.getElementById('energyLoading');
            loading.querySelector('.loading-text').textContent = 'Loading energy data...';
            
            try {
                // Try to get recent data
                const data = await fetchWithRetry(`${API_BASE}/hourly`);
                
                if (!data || data.length === 0) {
                    throw new Error('No data available');
                }
                
                renderEnergyChart(data);
                loading.classList.remove('active');
            } catch (error) {
                console.error('Error loading energy chart:', error);
                loading.querySelector('.loading-text').textContent = 'Failed to load energy data';
            }
        }

        function renderEnergyChart(data) {
            const labels = data.map(d => {
                const date = new Date(d.timestamp);
                return date.getHours() + ':00';
            });
            const solar = data.map(d => d.solar_generation_kw);
            const consumption = data.map(d => d.home_consumption_kw);
            const battery = data.map(d => d.battery_state_kwh);
            
            const ctx = document.getElementById('energyChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Solar Generation',
                            data: solar,
                            borderColor: '#fbbf24',
                            backgroundColor: 'rgba(251, 191, 36, 0.1)',
                            fill: true
                        },
                        {
                            label: 'Home Consumption',
                            data: consumption,
                            borderColor: '#60a5fa',
                            backgroundColor: 'rgba(96, 165, 250, 0.1)',
                            fill: true
                        },
                        {
                            label: 'Battery State',
                            data: battery,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Power (kW)', color: '#9ca3af' },
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#2d3748' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Battery (kWh)', color: '#9ca3af' },
                            ticks: { color: '#9ca3af' },
                            grid: { display: false }
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#2d3748' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#9ca3af' } }
                    }
                }
            });
        }

        // Fetch and display recommendations
        async function loadRecommendations() {
            try {
                const data = await fetchWithRetry(`${API_BASE}/recommendations`);
                const recList = document.getElementById('recList');
                
                // Show key recommendations only (peak hours + off-peak)
                const keyRecs = data.recommendations.filter(r => 
                    r.action !== 'hold' || r.hour % 6 === 0
                ).slice(0, 8);
                
                recList.innerHTML = keyRecs.map(rec => `
                    <div class="rec-item">
                        <div class="rec-hour">Hour ${rec.hour}:00 (Rate: $${rec.rate}/kWh)</div>
                        <div class="rec-action">${rec.action.replace(/_/g, ' ').toUpperCase()}</div>
                        <div class="rec-reason">${rec.reason}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading recommendations:', error);
                document.getElementById('recList').textContent = 'Failed to load recommendations';
            }
        }

        // Load all data on page load with staggered timing
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Starting data load...');
            
            // Load in sequence to avoid overwhelming the server during data generation
            try {
                await loadEnergyChart();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await loadCostAnalysis();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await loadStats();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await loadRecommendations();
                
                console.log('All data loaded successfully');
            } catch (error) {
                console.error('Error during initial load:', error);
            }
        });
    </script>
</body>
</html>